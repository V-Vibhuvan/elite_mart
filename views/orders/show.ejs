<% layout("layouts/boilerplate") %>

<style>
  .order-card { border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 6px 18px rgba(22,24,26,0.06); background: #fff; }
  .order-header { display:flex; justify-content:space-between; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .muted { color:#6b6b6b; font-size:.95rem; }
  .items-list { margin-top:1rem; }
  .item-row { display:grid; grid-template-columns: 100px 1fr 120px; gap:.75rem; align-items:center; padding:.75rem 0; border-bottom:1px solid #f1f1f1; }
  .item-row:last-child { border-bottom:none; }
  .item-img { width:100px; height:100px; object-fit:cover; border-radius:6px; }
  .address-box { border:1px solid #eee; padding: .75rem; border-radius:6px; background:#fafafa; }
  .meta-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:.75rem; align-items:center; }
  @media (max-width:767.98px) {
    .item-row { grid-template-columns: 72px 1fr 90px; }
    .meta-grid { grid-template-columns: 1fr; }
  }
</style>

<div class="container mt-4">

  <div class="row mb-3">
    <div class="col-12">
      <a href="/orders" class="btn btn-link">&larr; Back to orders</a>
      <h3>Order Details</h3>
      <p class="muted">Order overview and item status.</p>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">

      <% 
        const orderedAt = order.orderedAt ? new Date(order.orderedAt).toLocaleString("en-IN") : '';
        let orderTotal = 0;
        (order.items || []).forEach(it => {
          orderTotal += (it.priceSnapshot || (it.product && it.product.price ? it.product.price : 0)) * (it.quantity || 1);
        });
      %>

      <div class="order-card">

        <div class="order-header mb-2">
          <div>
            <div><strong>Order</strong> <span class="muted">#<%= order._id %></span></div>
            <div class="muted">Placed: <%= orderedAt %></div>
            <div class="muted">Payment status: <strong><%= order.paymentStatus %></strong></div>
          </div>

          <div class="text-end">
            <div class="muted">Items: <%= (order.items || []).length %></div>
            <div style="font-size:1.15rem; margin-top:.25rem">
              <strong>₹ <%= orderTotal.toFixed(2) %></strong>
            </div>
          </div>
        </div>

        <hr />

        <div class="items-list">
          <% (order.items || []).forEach(function(item){ %>
            <% 
              const price = (typeof item.priceSnapshot !== "undefined" && item.priceSnapshot !== null) 
                              ? item.priceSnapshot 
                              : (item.product && item.product.price ? item.product.price : 0);
              const qty = item.quantity || 1;
            %>

            <div class="item-row">
              <div>
                <a href="/products/<%= item.product ? item.product._id : '#' %>">
                  <img
                    src="<%= item.product.image[0].url %>"
                    alt="<%= item.titleSnapshot || (item.product && item.product.title) || 'Product' %>"
                    class="item-img"
                  />
                </a>
              </div>

              <div>
                <div><strong>
                  <a href="/products/<%= item.product ? item.product._id : '#' %>">
                    <%= item.titleSnapshot || (item.product && item.product.title) || "Product" %>
                  </a>
                </strong></div>

                <div class="muted" style="margin-top:.25rem">
                  Quantity: <%= qty %> • Unit price: ₹ <%= Number(price) %>
                </div>
              </div>

              <div class="text-end">
                <div class="muted">Item total</div>
                <div style="font-size:1rem; margin-top:.25rem">
                  <strong>₹ <%= (price * qty).toFixed(2) %></strong>
                </div>
                <div class="muted" style="margin-top:.5rem">Status: <strong><%= item.status || 'Packed' %></strong></div>
              </div>
            </div>
          <% }) %>
        </div>

      </div>
    </div>

    <div class="col-lg-4">
      <div class="order-card">
        <h6 class="mb-2">Shipping address</h6>

        <div class="address-box">
          <div><strong><%= order.shippingAddress.fullName %></strong></div>
          <div class="muted"><%= order.shippingAddress.phone %></div>
          <div class="muted"><%= order.shippingAddress.street %></div>
          <div class="muted">
            <%= order.shippingAddress.city %>, <%= order.shippingAddress.state %> - <%= order.shippingAddress.pincode %>
          </div>
          <div class="muted"><%= order.shippingAddress.country %></div>
          <div class="muted">Landmark: <%= order.shippingAddress.landmark %></div>
        </div>

        <hr />

        <h6 class="mb-2">Order summary</h6>

        <div class="meta-grid" style="margin-bottom:.5rem">
          <div class="muted">Order ID</div>
          <div class="muted">Placed</div>
          <div class="muted">Payment</div>

          <div><strong>#<%= order._id %></strong></div>
          <div><%= orderedAt %></div>
          <div><strong><%= order.paymentStatus %></strong></div>
        </div>

        <div style="margin-top:.5rem">
          <div class="muted">Total</div>
          <div style="font-size:1.25rem"><strong>₹ <%= orderTotal.toFixed(2) %></strong></div>
        </div>

        <div class="mt-3">
          <a href="/products" class="btn btn-outline-primary w-100 mb-2">Continue Shopping</a>
          <a href="/orders" class="btn btn-outline-secondary w-100">Back to Orders</a>
        </div>

      </div>
    </div>
  </div>
</div>
