<% layout("layouts/boilerplate") %>

<style>
  .profile-card {
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 6px 18px rgba(22,24,26,0.06);
    background: #fff;
  }
  .addr-card {
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 6px 18px rgba(22,24,26,0.04);
    background: #fff;
  }
  .muted { color: #6b6b6b; }
  .label { font-weight: 600; }
  .default-badge { background: #0d6efd; color: white; padding: 2px 8px; border-radius: 999px; font-size: .8rem; }
  .actions .btn { min-width: 110px; }
  @media (max-width: 767.98px) {
    .addr-card { padding: .75rem; }
  }
</style>

<div class="container mt-5">
  <div class="row g-4">
    <!-- Left: Profile & Addresses -->
    <div class="col-lg-8">
      <!-- Profile card -->
      <div class="card profile-card mb-3">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5><%= user.username || "User" %></h5>
            <p class="mb-1 muted">Email: <strong><%= user.email %></strong></p>
            <p class="mb-1 muted">Phone: <strong><%= user.phone || "Not provided" %></strong></p>
            <p class="small muted mb-0">Member since: <%= new Date(user.createdAt).toLocaleDateString() %></p>
          </div>
          <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <!-- Quick edit profile button toggles inline form -->
                <button id="toggleEditProfile" class="btn btn-outline-secondary">Edit Profile</button>
                <% if (currUser) { %>
                    <a href="/addresses/new" class="btn btn-primary ms-2">Add Address</a>
                <% } else { %>
                    <a href="/signup" class="btn btn-primary ms-2">Sign up to add address</a>
                <% } %>
            </div>
        </div>

        <!-- Inline edit form (hidden by default) -->
        <div id="editProfileForm" class="mt-3" style="display:none;">
          <form action="/profile?_method=PUT" method="POST" class="needs-validation" novalidate>
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label label" for="username">Username</label>
                <input id="username" name="username" class="form-control" value="<%= user.username || '' %>" required />
                <div class="invalid-feedback">Username is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label label" for="email">Email</label>
                <input id="email" name="email" type="email" class="form-control" value="<%= user.email || '' %>" required />
                <div class="invalid-feedback">Valid email is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label label" for="phone">Phone</label>
                <input id="phone" name="phone" type="tel" class="form-control" value="<%= user.phone || '' %>" />
              </div>
            </div>
            <div class="mt-2">
              <button class="btn btn-primary" type="submit">Save</button>
              <button id="cancelEditProfile" class="btn btn-outline-secondary" type="button">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Addresses list -->
      <div class="mb-2">
        <h5 class="mb-3">Your Addresses</h5>
        <% if (!user.addresses || user.addresses.length === 0) { %>
          <div class="alert alert-info">No addresses yet. Add one to proceed with orders.</div>
        <% } else { %>
          <% user.addresses.forEach(function(addr){ %>
            <div class="card addr-card mb-3">
              <div class="row">
                <div class="col-md-9">
                  <div class="d-flex align-items-start justify-content-between">
                    <div>
                      <div class="label mb-1"><%= addr.fullName || 'Name' %>
                        <% if (String(user.defaultAddress) === String(addr._id)) { %>
                          <span class="default-badge ms-2">Default</span>
                        <% } %>
                      </div>
                      <div class="muted small"><%= addr.phone || '' %> • <%= addr.pincode || '' %></div>
                    </div>
                    <div class="text-end d-md-none">
                    </div>
                  </div>

                  <div class="mt-2">
                    <div><%= addr.street %>, <%= addr.city %>, <%= addr.state %>, <%= addr.country %></div>
                    <% if (addr.landmark) { %>
                      <div class="muted small">Landmark: <%= addr.landmark %></div>
                    <% } %>
                  </div>
                </div>

                <div class="col-md-3 text-md-end mt-3 mt-md-0 actions">
                  <a href="/addresses/<%= addr._id %>/edit" class="btn btn-outline-dark btn-sm mb-2 w-100">Edit</a>

                  <form action="/addresses/<%= addr._id %>?_method=DELETE" method="POST" class="d-inline w-100 mb-2" onsubmit="return confirm('Delete this address?');">
                    <button type="submit" class="btn btn-danger btn-sm w-100">Remove</button>
                  </form>

                  <% if (String(user.defaultAddress) !== String(addr._id)) { %>
                    <form action="/addresses/<%= addr._id %>/default?_method=PUT" method="POST" class="d-inline w-100">
                      <button type="submit" class="btn btn-primary btn-sm w-100">Set Default</button>
                    </form>
                  <% } else { %>
                    <button class="btn btn-secondary btn-sm w-100" disabled>Default</button>
                  <% } %>
                </div>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>

    <!-- Right: Orders summary / quick links -->
    <div class="col-lg-4">
      <div class="card profile-card mb-3 p-3">
        <h6 class="mb-2">Account</h6>
        <p class="mb-1 muted">Username: <strong><%= user.username || '—' %></strong></p>
        <p class="mb-1 muted">Email: <strong><%= user.email %></strong></p>
        <p class="mb-1 muted">Addresses: <strong><%= user.addresses ? user.addresses.length : 0 %></strong></p>
        <hr/>
        <a href="/seller/soldItems" class="btn btn-outline-secondary w-100 mb-2">Sold Items</a>
        <a href="/orders" class="btn btn-outline-secondary w-100 mb-2">My Orders</a>
        <a href="/products" class="btn btn-outline-secondary w-100">Continue Shopping</a>
      </div>

      <div class="card addr-card p-3">
        <h6 class="mb-2">Need help?</h6>
        <p class="small muted mb-1">For support contact: <strong>support@example.com</strong></p>
        <p class="small muted mb-0">Phone: 1800-XXX-XXXX</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Toggle profile edit
  const toggleBtn = document.getElementById('toggleEditProfile');
  const editForm = document.getElementById('editProfileForm');
  const cancelEdit = document.getElementById('cancelEditProfile');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
      window.scrollTo({ top: editForm.offsetTop - 60, behavior: 'smooth' });
    });
  }
  if (cancelEdit) cancelEdit.addEventListener('click', () => { editForm.style.display = 'none'; });
</script>
